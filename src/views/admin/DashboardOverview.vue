<template>
  <div class="space-y-6">
    <div>
      <h2 class="text-2xl font-bold text-slate-900">æ•°æ®æ¦‚è§ˆ</h2>
      <p class="text-sm text-slate-600 mt-1">å®æ—¶ç›‘æ§åœè½¦ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</p>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600">æ€»åœè½¦åœºæ•°</p>
            <p class="text-3xl font-bold text-slate-900 mt-2">
              {{ stats.totalParkingLots }}
            </p>
          </div>
          <div
            class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
          >
            <span class="text-2xl">ğŸ…¿ï¸</span>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600">æ€»è½¦ä½æ•°</p>
            <p class="text-3xl font-bold text-slate-900 mt-2">
              {{ stats.totalSpots }}
            </p>
          </div>
          <div
            class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center"
          >
            <span class="text-2xl">ğŸ“</span>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600">å ç”¨ç‡</p>
            <p class="text-3xl font-bold text-slate-900 mt-2">
              {{ stats.occupancyRate }}%
            </p>
          </div>
          <div
            class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center"
          >
            <span class="text-2xl">ğŸ“Š</span>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600">å…±äº«è½¦ä½æ•°</p>
            <p class="text-3xl font-bold text-slate-900 mt-2">
              {{ stats.pendingShared }}
            </p>
          </div>
          <div
            class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"
          >
            <span class="text-2xl">ğŸ </span>
          </div>
        </div>
      </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
      <h3 class="text-lg font-semibold text-slate-900 mb-4">å¿«é€Ÿæ“ä½œ</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <router-link
          to="/admin/dashboard/parking-lots"
          class="flex items-center gap-3 p-4 rounded-lg border border-slate-200 hover:border-emerald-300 hover:bg-emerald-50 transition"
        >
          <span class="text-2xl">â•</span>
          <div>
            <p class="font-medium text-slate-900">æ·»åŠ åœè½¦åœº</p>
            <p class="text-xs text-slate-600">æ–°å¢åœè½¦åœºä¿¡æ¯</p>
          </div>
        </router-link>
        <router-link
          to="/admin/dashboard/parking-status"
          class="flex items-center gap-3 p-4 rounded-lg border border-slate-200 hover:border-emerald-300 hover:bg-emerald-50 transition"
        >
          <span class="text-2xl">âœ…</span>
          <div>
            <p class="font-medium text-slate-900">æŸ¥çœ‹å®æ—¶è½¦ä½çŠ¶æ€</p>
            <p class="text-xs text-slate-600">æŸ¥çœ‹æ‰€æœ‰åœè½¦åœºè½¦ä½çŠ¶æ€</p>
          </div>
        </router-link>
        <router-link
          to="/admin/dashboard/reports"
          class="flex items-center gap-3 p-4 rounded-lg border border-slate-200 hover:border-emerald-300 hover:bg-emerald-50 transition"
        >
          <span class="text-2xl">âš ï¸</span>
          <div>
            <p class="font-medium text-slate-900">å¤„ç†ä¸¾æŠ¥</p>
            <p class="text-xs text-slate-600">æŸ¥çœ‹ç”¨æˆ·ä¸¾æŠ¥</p>
          </div>
        </router-link>
      </div>
    </div>

    <!-- å›¾è¡¨å’Œç³»ç»ŸçŠ¶æ€ -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- åœè½¦åœºç±»å‹åˆ†å¸ƒ (é¥¼å›¾) -->
      <div
        class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6 border border-slate-200"
      >
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
          åœè½¦åœºç±»å‹åˆ†å¸ƒ
        </h3>
        <div ref="typePieChart" class="h-64 w-full"></div>
      </div>

      <!-- ç³»ç»ŸçŠ¶æ€ä¿¡æ¯ -->
      <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">ç³»ç»Ÿå¥åº·çŠ¶æ€</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">åç«¯æ¥å£æœåŠ¡</span>
            <span
              class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700"
              >è¿è¡Œä¸­</span
            >
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">æ•°æ®åº“è¿æ¥</span>
            <span
              class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700"
              >æ­£å¸¸</span
            >
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">å®æ—¶æ¨é€æœåŠ¡</span>
            <span
              class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700"
              >åœ¨çº¿</span
            >
          </div>
          <div class="pt-4 border-t border-slate-100">
            <p class="text-xs text-slate-500 mb-2">ç³»ç»Ÿè´Ÿè½½ (CPU/å†…å­˜)</p>
            <div class="w-full bg-slate-100 rounded-full h-2 mb-3">
              <div
                class="bg-blue-500 h-2 rounded-full"
                style="width: 24%"
              ></div>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-2">
              <div
                class="bg-purple-500 h-2 rounded-full"
                style="width: 42%"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æœ€è¿‘æ´»åŠ¨ä¸å…¬å‘Š -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- æœ€è¿‘æ´»åŠ¨ -->
      <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">æœ€è¿‘æ´»åŠ¨</h3>
        <div class="space-y-3">
          <div
            v-for="(activity, index) in recentActivities"
            :key="index"
            class="flex items-center gap-3 p-3 rounded-lg bg-slate-50 hover:bg-slate-100 transition"
          >
            <span class="text-xl">{{ getActivityIcon(activity.type) }}</span>
            <div class="flex-1">
              <p class="text-sm font-medium text-slate-900">
                {{ formatActivityTitle(activity) }}
              </p>
              <p class="text-xs text-slate-600">{{ activity.time }}</p>
            </div>
            <button
              class="text-xs text-blue-600 hover:underline"
              @click="viewActivity(activity)"
            >
              æŸ¥çœ‹
            </button>
          </div>
          <div
            v-if="recentActivities.length === 0"
            class="py-10 text-center text-slate-400 text-sm"
          >
            æš‚æ— æœ€è¿‘æ´»åŠ¨
          </div>
        </div>
      </div>

      <!-- å¾…åŠä»»åŠ¡ -->
      <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-slate-900">å¾…åŠä»»åŠ¡</h3>
        </div>
        <div class="space-y-4">
          <!-- ç´§æ€¥ä¸¾æŠ¥å¤„ç† -->
          <div
            class="flex items-start gap-3 p-3 rounded-lg border-l-4 border-red-400 bg-red-50"
          >
            <span class="text-xl">ğŸ›¡ï¸</span>
            <div>
              <p class="text-sm font-semibold text-red-800">ç´§æ€¥ä¸¾æŠ¥å¤„ç†</p>
              <p class="text-xs text-red-700 mt-1">
                å½“å‰æœ‰ {{ stats.pendingReports }} æ¡ä¸¾æŠ¥å¾…å¤„ç†
              </p>
              <router-link
                to="/admin/dashboard/reports"
                class="text-xs text-red-800 font-bold mt-2 inline-block hover:underline"
                >å»å¤„ç† â†’</router-link
              >
            </div>
          </div>

          <!-- å®æ—¶è½¦ä½çŠ¶æ€å·¡æ£€ -->
          <div
            class="flex items-start gap-3 p-3 rounded-lg border-l-4 border-blue-400 bg-blue-50"
          >
            <span class="text-xl">ğŸ“¡</span>
            <div>
              <p class="text-sm font-semibold text-blue-800">
                æŸ¥çœ‹è½¦ä½å®æ—¶çŠ¶æ€
              </p>
              <p class="text-xs text-blue-700 mt-1">
                å»ºè®®å®šæœŸæ£€æŸ¥é‡ç‚¹åœè½¦åœºçš„å®æ—¶å ç”¨æƒ…å†µ
              </p>
              <router-link
                to="/admin/dashboard/parking-status"
                class="text-xs text-blue-800 font-bold mt-2 inline-block hover:underline"
                >å‰å¾€ç›‘æ§ â†’</router-link
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import Vue from "vue";
import * as echarts from "echarts";
import {
  getDashboardStats,
  getAdminParkingLots,
  getRecentActivities,
} from "@/api/Admin";
import { ActivityVO, DashboardStatsVO } from "@/api/index";

export default Vue.extend({
  name: "DashboardOverview",
  data() {
    return {
      loading: false,
      stats: {
        totalParkingLots: 0,
        totalSpots: 0,
        occupancyRate: 0,
        pendingShared: 0,
        pendingReports: 0,
      } as DashboardStatsVO,
      recentActivities: [] as ActivityVO[],
      charts: {
        typePie: null as echarts.ECharts | null,
      },
    };
  },
  mounted() {
    this.initCharts();
    this.loadData();
    window.addEventListener("resize", this.handleResize);
  },
  beforeDestroy() {
    window.removeEventListener("resize", this.handleResize);
    this.charts.typePie?.dispose();
  },
  methods: {
    /**
     * åŠ è½½æ•°æ®
     */
    async loadData() {
      this.loading = true;
      try {
        await Promise.all([
          this.loadStats(),
          this.loadActivities(),
          this.loadParkingTypeDistribution(),
        ]);
      } finally {
        this.loading = false;
      }
    },

    /**
     * è·å–å›¾æ ‡
     */
    getActivityIcon(type: string): string {
      const icons: Record<string, string> = {
        report: "âš ï¸",
        parking: "ğŸ…¿ï¸",
        shared: "ğŸ ",
        audit: "âœ…",
        system: "ğŸš€",
      };
      return icons[type] || "ğŸ“";
    },

    /**
     * æ ¼å¼åŒ–æ´»åŠ¨æ ‡é¢˜
     * å°†æ´»åŠ¨æ ‡é¢˜ä¸­çš„è‹±æ–‡ä¸¾æŠ¥ç±»å‹ä»£ç è½¬æ¢ä¸ºä¸­æ–‡
     */
    formatActivityTitle(activity: ActivityVO): string {
      let title = activity.title;

      // å¦‚æœæ˜¯ä¸¾æŠ¥ç±»å‹çš„æ´»åŠ¨ï¼Œéœ€è¦å°†æ ‡é¢˜ä¸­çš„è‹±æ–‡ç±»å‹ä»£ç è½¬æ¢ä¸ºä¸­æ–‡
      if (activity.type === "report") {
        // å®šä¹‰ä¸¾æŠ¥ç±»å‹ä»£ç åˆ°ä¸­æ–‡çš„æ˜ å°„
        const reportTypeMap: Record<string, string> = {
          false_info: "è™šå‡ä¿¡æ¯",
          price_fraud: "ä»·æ ¼æ¬ºè¯ˆ",
          service_issue: "æœåŠ¡é—®é¢˜",
          safety_issue: "å®‰å…¨éšæ‚£",
          other: "å…¶ä»–é—®é¢˜",
        };

        // éå†æ‰€æœ‰ä¸¾æŠ¥ç±»å‹ï¼Œå°†æ ‡é¢˜ä¸­çš„è‹±æ–‡ä»£ç æ›¿æ¢ä¸ºä¸­æ–‡
        Object.keys(reportTypeMap).forEach((code) => {
          const regex = new RegExp(code, "g");
          title = title.replace(regex, reportTypeMap[code]);
        });
      }

      return title;
    },

    /**
     * åŠ è½½æ´»åŠ¨è®°å½•
     */
    async loadActivities() {
      try {
        const res = await getRecentActivities();
        if (res.data?.code === 200) {
          this.recentActivities = res.data.data || [];
        }
      } catch (error) {
        console.error("åŠ è½½æ´»åŠ¨å¤±è´¥:", error);
      }
    },

    /**
     * åˆå§‹åŒ–å›¾è¡¨
     */
    initCharts() {
      this.charts.typePie = echarts.init(
        this.$refs.typePieChart as HTMLElement
      );
    },

    /**
     * å¤„ç†çª—å£ç¼©æ”¾
     */
    handleResize() {
      this.charts.typePie?.resize();
    },

    /**
     * åŠ è½½åœè½¦åœºç±»å‹åˆ†å¸ƒæ•°æ®
     */
    async loadParkingTypeDistribution() {
      try {
        const res = await getAdminParkingLots({ pageNum: 1, pageSize: 1000 });
        if (res.data?.code === 200) {
          const lots = res.data.data.data;
          const publicCount = lots.filter((l) => l.type === 0).length;
          const businessCount = lots.filter((l) => l.type === 1).length;

          this.charts.typePie?.setOption({
            tooltip: { trigger: "item" },
            legend: { bottom: "0", left: "center" },
            series: [
              {
                name: "åœè½¦åœºç±»å‹",
                type: "pie",
                radius: ["40%", "70%"],
                avoidLabelOverlap: false,
                itemStyle: {
                  borderRadius: 10,
                  borderColor: "#fff",
                  borderWidth: 2,
                },
                label: { show: false, position: "center" },
                emphasis: {
                  label: { show: true, fontSize: "20", fontWeight: "bold" },
                },
                labelLine: { show: false },
                data: [
                  {
                    value: publicCount,
                    name: "å…¬å…±åœè½¦åœº",
                    itemStyle: { color: "#10b981" },
                  },
                  {
                    value: businessCount,
                    name: "å…±äº«åœè½¦åœº",
                    itemStyle: { color: "#3b82f6" },
                  },
                ],
              },
            ],
          });
        }
      } catch (error) {
        console.error("åŠ è½½åœè½¦åœºåˆ†å¸ƒå¤±è´¥:", error);
      }
    },

    /**
     * åŠ è½½ç»Ÿè®¡æ•°æ®
     */
    async loadStats() {
      try {
        const res = await getDashboardStats();
        if (res.data?.code === 200) {
          this.stats = res.data.data || {
            totalParkingLots: 0,
            totalSpots: 0,
            occupancyRate: 0,
            pendingShared: 0,
            pendingReports: 0,
          };
        } else {
          this.$message.error(res.data?.message || "è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥");
        }
      } catch (error) {
        console.error("åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:", error);
        this.$message.error("è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
      }
    },

    /**
     * æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…
     * æ ¹æ®æ´»åŠ¨ç±»å‹è·³è½¬åˆ°ç›¸åº”çš„ç®¡ç†é¡µé¢
     */
    viewActivity(activity: ActivityVO) {
      try {
        // æ ¹æ®æ´»åŠ¨ç±»å‹è·³è½¬åˆ°ç›¸åº”çš„é¡µé¢
        if (activity.type === "report") {
          {
            this.$router.push("/admin/dashboard/reports");
          }
        } else {
          this.$router.push("/admin/dashboard/parking-lots");
        }
      } catch (error) {
        console.error("è·³è½¬å¤±è´¥:", error);
        this.$message.error("è·³è½¬å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
      }
    },
  },
});
</script>
